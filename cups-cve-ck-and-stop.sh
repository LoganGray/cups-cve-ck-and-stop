#!/bin/bash

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if script is run as root
if [ "$(id -u)" != "0" ]; then
   echo -e "${RED}This script must be run as root${NC}" 1>&2
   exit 1
fi

# Function to check if a process is running
check_process() {
    if pgrep -x "$1" > /dev/null; then
        echo -e "${GREEN}$1 is running${NC}"
        return 0
    else
        echo -e "${RED}$1 is not running${NC}"
        return 1
    fi
}

# Function to check if a library is installed
check_library() {
    if ldconfig -p | grep -q "$1"; then
        echo -e "${GREEN}$1 is installed${NC}"
        return 0
    else
        echo -e "${RED}$1 is not installed${NC}"
        return 1
    fi
}

# Function to stop and disable a service
stop_and_disable_service() {
    echo -e "${YELLOW}Stopping $1 service...${NC}"
    systemctl stop $1
    echo -e "${YELLOW}Disabling $1 service...${NC}"
    systemctl disable $1
    echo -e "${GREEN}$1 has been stopped and disabled${NC}"
}

# Initialize arrays to store running processes and installed libraries
running_processes=()
installed_libraries=()

# Check cups-browsed
if check_process "cups-browsed"; then
    running_processes+=("cups-browsed")
fi

# Check cups-filters (assuming it runs as a process named cups-filter)
if check_process "cups-filter"; then
    running_processes+=("cups-filter")
fi

# Check libcupsfilters
if check_library "libcupsfilters"; then
    installed_libraries+=("libcupsfilters")
fi

# Check libppd
if check_library "libppd"; then
    installed_libraries+=("libppd")
fi

# If any processes are running or libraries are installed, ask user if they want to stop/disable
if [ ${#running_processes[@]} -ne 0 ] || [ ${#installed_libraries[@]} -ne 0 ]; then
    echo -e "\n${YELLOW}The following components are active:${NC}"
    for process in "${running_processes[@]}"; do
        echo "- $process (running)"
    done
    for library in "${installed_libraries[@]}"; do
        echo "- $library (installed)"
    done
    
    read -p "Do you want to stop running processes and disable them from starting automatically? (y/N) " response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        for process in "${running_processes[@]}"; do
            stop_and_disable_service $process
        done
        echo -e "${YELLOW}Note: Installed libraries (${installed_libraries[*]}) cannot be 'stopped' or 'disabled'.${NC}"
        echo -e "${YELLOW}If you need to remove them, use your system's package manager.${NC}"
    else
        echo -e "${GREEN}No changes were made to the system.${NC}"
    fi
else
    echo -e "\n${GREEN}No CUPS components are currently active.${NC}"
fi

exit 0
